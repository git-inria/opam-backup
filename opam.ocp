(* Uncomment to use with TypeRex *)
(*
   ocamlc   = [ "ocp-ocamlc.opt" ]
   ocamlopt = [ "ocp-ocamlopt.opt" ]
*)
 
begin
  comp += [ "-g" "-annot" "-warn-error" "A" ]
  link += [ "-g" ]

begin library "opam-lib"
  dirname = [ "src" ]
  files   = [
    "globals.ml"
    "utils.ml"
    "process.ml"
    "run.ml"
    "parallel.ml"
    "types.ml"
    "file_format.ml"
    "lexer.mll"
    "linelexer.mll"
    "parser.mly"
    "file.ml"
    "path.ml"
    "repositories.ml"
    "repo/repo_helpers.ml"
  ]

  requires = [
    "cudf"
    "dose"
    "unix"
    "arg"
    "graph"
    "re_perl"
  ]
end

begin program "opam"
  dirname  = [ "src" ]
  files    = [
    "solver.ml"
    "client.ml"
    "opam.ml"
  ]
  requires = [ "opam-lib" ]
end

(* Repository Scripts *)

(* RSYNC *)
begin library "opam-rsync-lib"
  files = [ "src/repo/rsync/rsync.ml" ]
  requires = [ "opam-lib" ]
end

begin program "opam-rsync-init"
  files = [ "src/repo/rsync/init.ml" ]
  requires = [ "opam-rsync-lib" ]
end

begin program "opam-rsync-update"
  files = [ "src/repo/rsync/update.ml" ]
  requires = [ "opam-rsync-lib" ]
end

begin program "opam-rsync-download"
  files = [ "src/repo/rsync/download.ml" ]
  requires = [ "opam-rsync-lib" ]
end

begin program "opam-rsync-upload"
  files = [ "src/repo/rsync/upload.ml" ]
  requires = [ "opam-rsync-lib" ]
end

(* CURL *)
begin library "opam-curl-lib"
  files = [ "src/repo/curl/curl.ml" ]
  requires = [ "opam-lib" ]
end

begin program "opam-curl-init"
  files = [ "src/repo/curl/init.ml" ]
  requires = [ "opam-curl-lib" ]
end

begin program "opam-curl-update"
  files = [ "src/repo/curl/update.ml" ]
  requires = [ "opam-curl-lib" ]
end

begin program "opam-curl-download"
  files = [ "src/repo/curl/download.ml" ]
  requires = [ "opam-curl-lib" ]
end

begin program "opam-curl-upload"
  files = [ "src/repo/curl/upload.ml" ]
  requires = [ "opam-curl-lib" ]
end


(* GIT *)
begin library "opam-git-lib"
  files = [ "src/repo/git/git.ml" ]
  requires = [ "opam-lib" ]
end

begin program "opam-git-init"
  files = [ "src/repo/git/init.ml" ]
  requires = [ "opam-git-lib" ]
end

begin program "opam-git-update"
  files = [ "src/repo/git/update.ml" ]
  requires = [ "opam-git-lib" ]
end

begin program "opam-git-download"
  files = [ "src/repo/git/download.ml" ]
  requires = [ "opam-git-lib" ]
end

begin program "opam-git-upload"
  files = [ "src/repo/git/upload.ml" ]
  requires = [ "opam-git-lib" ]
end


(* SERVER *)
begin library "opam-server-lib"
  files = [
    "src/repo/server/protocol.ml"
    "src/repo/server/key.ml"
    "src/repo/server/client.ml"
  ]
  requires = [ "opam-lib" ]
end

begin program "opam-server"
  files = [
    "src/repo/server/daemon.ml"
    "src/repo/server/server.ml"
  ]
  comp += [ "-thread" ]
  link += [ "-thread" ]
  requires = [
    "opam-server-lib"
    "threads"
  ]
end

begin program "opam-server-init"
  files = [ "src/repo/server/init.ml" ]
  requires = [ "opam-server-lib" ]
end

begin program "opam-server-update"
  files = [ "src/repo/server/update.ml" ]
  requires = [ "opam-server-lib" ]
end

begin program "opam-server-download"
  files = [ "src/repo/server/download.ml" ]
  requires = [ "opam-server-lib" ]
end

begin program "opam-server-upload"
  files = [ "src/repo/server/upload.ml" ]
  requires = [ "opam-server-lib" ]
end

(* Helpers *)

begin program "opam-mk-config"
  files = [ "src/scripts/opam_mk_config.ml" ]
  requires = [ "opam-lib" ]
end

begin program "opam-mk-install"
  files = [ "src/scripts/opam_mk_install.ml" ]
  requires = [ "opam-lib" ]
end

begin program "opam-mk-repo"
  files = [ "src/scripts/opam_mk_repo.ml" ]
  requires = [ "opam-curl-lib" ]
end

begin program "opam-check"
  files = [ "src/scripts/opam_check.ml" ]
  requires = [ "opam-lib" ]
end

begin program "opam-repo-convert-0.3"
  files = [ "src/scripts/opam_repo_convert.ml" ]
  requires = [ "opam-lib" ]
end

end
